#!/data/data/com.termux/files/usr/bin/bash -e

# =======================================================
# åŸåˆ›ä½œè€…ï¼šåŠ³cd (QQ: 2042716620)
# è°è¯´å›½äººç”¨ä¸äº†ğŸ¤“
# Kali NetHunter Termux å®‰è£…è„šæœ¬
# æœ¬è„šæœ¬åªä¸ºå›½äººæœ‰æ›´å¥½çš„ä½“éªŒ
# =======================================================

function check_deps() {
    for tool in wget proot tar; do
        if ! command -v $tool &>/dev/null; then
            echo "[*] æ£€æµ‹åˆ°ç¼ºå°‘ä¾èµ–: $tool"
            pkg install $tool -y || {
                echo "[!] æ— æ³•è‡ªåŠ¨å®‰è£… $toolï¼Œè¯·æ‰‹åŠ¨å®‰è£…: pkg install $tool"
                exit 1
            }
        fi
    done
}

# åœ¨ä¸‹è½½å‰è°ƒç”¨è¯¥å‡½æ•°
check_deps

VERSION=2024091801
BASE_URL=https://image-nethunter.kali.org/nethunter-fs/kali-2025.1
USERNAME=kali

function unsupported_arch() {
    printf "${red}"
    echo "[*] ä¸æ”¯æŒçš„è®¾å¤‡æ¶æ„\n\n"
    printf "${reset}"
    exit
}

function get_arch() {
    printf "${blue}[*] æ­£åœ¨æ£€æµ‹è®¾å¤‡æ¶æ„ ...${reset}"
    case $(getprop ro.product.cpu.abi) in
        arm64-v8a)
            SYS_ARCH=arm64
            printf "\n${green}[+] è®¾å¤‡æ¶æ„: ${green}arm64${reset}\n"
            ;;
        armeabi|armeabi-v7a)
            SYS_ARCH=armhf
            printf "\n${green}[+] è®¾å¤‡æ¶æ„: ${green}armhf${reset}\n"
            ;;
        *)
            printf "${red}\n[!] é”™è¯¯: ä¸æ”¯æŒçš„æ¶æ„! ä»…æ”¯æŒ arm64/armhfã€‚${reset}\n"
            exit 1
            ;;
    esac
}

function set_strings() {
    # è‡ªåŠ¨é€‰æ‹©å®Œæ•´ç‰ˆé•œåƒ
    wimg="full"
    printf "\n[+] è‡ªåŠ¨é€‰æ‹©å®Œæ•´ç‰ˆé•œåƒ: ${green}${wimg}${reset}\n"
    
    CHROOT="kali-${SYS_ARCH}"
    IMAGE_NAME="kali-nethunter-2025.1-rootfs-${wimg}-${SYS_ARCH}.tar.xz"
    SHA_NAME="${IMAGE_NAME}.sha512sum"
    printf "\n[+] é•œåƒæ–‡ä»¶å: ${green}${IMAGE_NAME}${reset}\n"
}

function prepare_fs() {
    # è‡ªåŠ¨åˆ é™¤å·²å­˜åœ¨çš„ç›®å½•
    if [ -d ${CHROOT} ]; then
        echo "[*] æ£€æµ‹åˆ°å·²å­˜åœ¨çš„ rootfs ç›®å½•ï¼Œè‡ªåŠ¨åˆ é™¤ä¸­..."
        rm -rf ${CHROOT}
    fi
} 

function get_url() {
    BASE_URL="https://image-nethunter.kali.org/nethunter-fs/kali-2025.1"
    ROOTFS_URL="${BASE_URL}/${IMAGE_NAME}"
    SHA_URL="${BASE_URL}/${SHA_NAME}"

    printf "${blue}[*] æ­£åœ¨éªŒè¯é•œåƒé“¾æ¥...${reset}\n"
    if ! curl --head --silent --fail "${ROOTFS_URL}" >/dev/null; then
        printf "${red}[!] é”™è¯¯: é•œåƒä¸å­˜åœ¨! è¯·æ£€æŸ¥ä»¥ä¸‹é“¾æ¥ï¼š\n${ROOTFS_URL}\n${reset}"
        exit 1
    fi
    printf "[+] é•œåƒå¯ä¸‹è½½: ${green}${ROOTFS_URL}${reset}\n"
}

function get_rootfs() {
    # è‡ªåŠ¨é‡æ–°ä¸‹è½½é•œåƒ
    if [ -f "${IMAGE_NAME}" ]; then
        echo "[*] æ£€æµ‹åˆ°å·²ä¸‹è½½çš„é•œåƒæ–‡ä»¶ï¼Œè‡ªåŠ¨åˆ é™¤ä¸­..."
        rm -f "${IMAGE_NAME}"
    fi

    printf "${blue}[*] æ­£åœ¨ä¸‹è½½ root æ–‡ä»¶ç³»ç»Ÿ (${IMAGE_NAME})...${reset}\n"
    get_url
    if ! wget --continue --tries=3 --timeout=60 "${ROOTFS_URL}"; then
        printf "${red}[!] ä¸‹è½½å¤±è´¥! è¯·æ‰‹åŠ¨ä¸‹è½½å¹¶æ”¾å…¥å½“å‰ç›®å½•ï¼š\n${ROOTFS_URL}\n${reset}"
        exit 1
    fi
}

function check_sha_url() {
    if ! curl --head --silent --fail "${SHA_URL}" > /dev/null; then
        echo "[!] SHA æ–‡ä»¶ä¸å­˜åœ¨æˆ–æ— æ³•è®¿é—®"
        return 1
    fi
    return 0
}

function verify_sha() {
    printf "\n${blue}[*] æ­£åœ¨éªŒè¯ rootfs å®Œæ•´æ€§...${reset}\n\n"
    if [ -f "${SHA_NAME}" ]; then
        sha512sum -c "$SHA_NAME" || {
            printf "${red} rootfs æ–‡ä»¶å·²æŸåã€‚è¯·é‡æ–°è¿è¡Œå®‰è£…ç¨‹åºæˆ–æ‰‹åŠ¨ä¸‹è½½æ–‡ä»¶\n${reset}"
            exit 1
        }
    else
        echo "[!] æœªæ‰¾åˆ° SHA æ–‡ä»¶ï¼Œè·³è¿‡éªŒè¯..."    
    fi    
}

function get_sha() {
    printf "\n${blue}[*] æ­£åœ¨è·å– SHA æ ¡éªŒç ... ${reset}\n\n"
    get_url
    if [ -f "${SHA_NAME}" ]; then
        rm -f "${SHA_NAME}"
    fi        
    if check_sha_url; then
        echo "[+] SHA æ–‡ä»¶å­˜åœ¨ï¼Œç»§ç»­ä¸‹è½½..."
        wget --continue "${SHA_URL}"
        verify_sha
    else
        echo "[!] SHA æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè·³è¿‡ä¸‹è½½ã€‚"
    fi
}

function extract_rootfs() {
    printf "\n${blue}[*] æ­£åœ¨è§£å‹ rootfs... ${reset}\n\n"
    proot --link2symlink tar -xf "$IMAGE_NAME" 2> /dev/null || :
}

function create_launcher() {
    NH_LAUNCHER=${PREFIX}/bin/nethunter
    NH_SHORTCUT=${PREFIX}/bin/nh
    cat > "$NH_LAUNCHER" <<- EOF
#!/data/data/com.termux/files/usr/bin/bash -e
cd \${HOME}
unset LD_PRELOAD
if [ ! -f $CHROOT/root/.version ]; then
    touch $CHROOT/root/.version
fi

user="$USERNAME"
home="/home/\$user"
start="sudo -u kali /bin/bash"

if grep -q "kali" ${CHROOT}/etc/passwd; then
    KALIUSR="1";
else
    KALIUSR="0";
fi
if [[ \$KALIUSR == "0" || ("\$#" != "0" && ("\$1" == "-r" || "\$1" == "-R")) ]];then
    user="root"
    home="/\$user"
    start="/bin/bash --login"
    if [[ "\$#" != "0" && ("\$1" == "-r" || "\$1" == "-R") ]];then
        shift
    fi
fi

cmdline="proot \\
        --link2symlink \\
        -0 \\
        -r $CHROOT \\
        -b /dev \\
        -b /proc \\
        -b /sdcard \\
        -b $CHROOT\$home:/dev/shm \\
        -w \$home \\
           /usr/bin/env -i \\
           HOME=\$home \\
           PATH=/usr/local/sbin:/usr/local/bin:/bin:/usr/bin:/sbin:/usr/sbin \\
           TERM=\$TERM \\
           LANG=C.UTF-8 \\
           \$start"

cmd="\$@"
if [ "\$#" == "0" ];then
    exec \$cmdline
else
    \$cmdline -c "\$cmd"
fi
EOF

    chmod 700 "$NH_LAUNCHER"
    if [ -L "${NH_SHORTCUT}" ]; then
        rm -f "${NH_SHORTCUT}"
    fi
    if [ ! -f "${NH_SHORTCUT}" ]; then
        ln -s "${NH_LAUNCHER}" "${NH_SHORTCUT}" >/dev/null
    fi
}

function create_kex_launcher() {
    KEX_LAUNCHER=${CHROOT}/usr/bin/kex
    cat > $KEX_LAUNCHER <<- EOF
#!/bin/bash

function start-kex() {
    if [ ! -f ~/.vnc/passwd ]; then
        passwd-kex
    fi
    USR=\$(whoami)
    if [ \$USR == "root" ]; then
        SCREEN=":2"
    else
        SCREEN=":1"
    fi 
    export MOZ_FAKE_NO_SANDBOX=1; export HOME=\${HOME}; export USER=\${USR}; LD_PRELOAD=/usr/lib/aarch64-linux-gnu/libgcc_s.so.1 nohup vncserver \$SCREEN >/dev/null 2>&1 </dev/null
    starting_kex=1
    return 0
}

function stop-kex() {
    vncserver -kill :1 | sed s/"Xtigervnc"/"NetHunter KeX"/
    vncserver -kill :2 | sed s/"Xtigervnc"/"NetHunter KeX"/
    return $?
}

function passwd-kex() {
    vncpasswd
    return $?
}

function status-kex() {
    sessions=\$(vncserver -list | sed s/"TigerVNC"/"NetHunter KeX"/)
    if [[ \$sessions == *"590"* ]]; then
        printf "\n\${sessions}\n"
        printf "\næ‚¨å¯ä»¥ä½¿ç”¨ KeX å®¢æˆ·ç«¯è¿æ¥åˆ°ä»¥ä¸Šä»»æ„ä¼šè¯ã€‚\n\n"
    else
        if [ ! -z \$starting_kex ]; then
            printf '\nå¯åŠ¨ KeX æœåŠ¡å™¨æ—¶å‡ºé”™ã€‚\nè¯·å°è¯• "nethunter kex kill" æˆ–é‡å¯ Termux ä¼šè¯åé‡è¯•ã€‚\n\n'
        fi
    fi
    return 0
}

function kill-kex() {
    pkill Xtigervnc
    return \$?
}

case \$1 in
    start)
        start-kex
        ;;
    stop)
        stop-kex
        ;;
    status)
        status-kex
        ;;
    passwd)
        passwd-kex
        ;;
    kill)
        kill-kex
        ;;
    *)
        stop-kex
        start-kex
        status-kex
        ;;
esac
EOF

    chmod 700 $KEX_LAUNCHER
}

function fix_profile_bash() {
    if [ -f ${CHROOT}/root/.bash_profile ]; then
        sed -i '/if/,/fi/d' "${CHROOT}/root/.bash_profile"
    fi
}

function fix_resolv_conf() {
    echo "nameserver 9.9.9.9" > $CHROOT/etc/resolv.conf
    echo "nameserver 149.112.112.112" >> $CHROOT/etc/resolv.conf
}

function fix_sudo() {
    chmod +s $CHROOT/usr/bin/sudo
    chmod +s $CHROOT/usr/bin/su
    echo "kali    ALL=(ALL:ALL) ALL" > $CHROOT/etc/sudoers.d/kali
    echo "Set disable_coredump false" > $CHROOT/etc/sudo.conf
}

function fix_uid() {
    USRID=$(id -u)
    GRPID=$(id -g)
    nh -r usermod -u "$USRID" kali 2>/dev/null
    nh -r groupmod -g "$GRPID" kali 2>/dev/null
}

function print_banner() {
    clear
    printf "${blue}##################################################\n"
    printf "${blue}##                                              ##\n"
    printf "${blue}##  88      a8P         db        88        88  ##\n"
    printf "${blue}##  88    .88'         d88b       88        88  ##\n"
    printf "${blue}##  88   88'          d8''8b      88        88  ##\n"
    printf "${blue}##  88 d88           d8'  '8b     88        88  ##\n"
    printf "${blue}##  8888'88.        d8YaaaaY8b    88        88  ##\n"
    printf "${blue}##  88P   Y8b      d8''''''''8b   88        88  ##\n"
    printf "${blue}##  88     '88.   d8'        '8b  88        88  ##\n"
    printf "${blue}##  88       Y8b d8'          '8b 888888888 88  ##\n"
    printf "${blue}##                                              ##\n"
    printf "${blue}####  ############# NetHunter ####################${reset}\n\n"
    printf "${red}         _           _        _ _        \n"
    printf "${red}        | |         (_)      | | |       \n"
    printf "${red}        | | __ _ ___ _ ___   | | |_ ___  \n"
    printf "${red}    _   | |/ _\` / __| / __|  | | __/ _ \ \n"
    printf "${red}   | |__| | (_| \__ \ \__ \  | | || (_) |\n"
    printf "${red}    \____/ \__,_|___/_|___/   \_\_\___/ \n"
    printf "${green}------------------------------------------\n"
    printf "${green}      åŸåˆ›ä½œè€…: åŠ³cd (QQ: 2042716620)     \n"
    printf "${green}      ä¸­å›½å®šåˆ¶ç‰ˆ Kali NetHunter Termux     \n"
    printf "${green}------------------------------------------\n"
    printf "${reset}"
}

##################################
##             ä¸»ç¨‹åº           ##

red='\033[1;31m'
green='\033[1;32m'
yellow='\033[1;33m'
blue='\033[1;34m'
light_cyan='\033[1;96m'
reset='\033[0m'

cd "$HOME"
print_banner
get_arch
set_strings
prepare_fs
get_rootfs
get_sha
extract_rootfs
create_launcher
create_kex_launcher

printf "\n${blue}[*] æ­£åœ¨é…ç½® NetHunter for Termux ...\n"
fix_profile_bash
fix_resolv_conf
fix_sudo
fix_uid

print_banner
printf "${green}[=] Kali NetHunter for Termux å®‰è£…æˆåŠŸï¼${reset}\n\n"
printf "${green}[+] å¯åŠ¨æ–¹å¼:${reset}\n"
printf "${green}[+] nethunter             # å¯åŠ¨ CLI æ¨¡å¼${reset}\n"
printf "${green}[+] nethunter kex passwd  # è®¾ç½® KeX å¯†ç ${reset}\n"
printf "${green}[+] nethunter kex &       # å¯åŠ¨ GUI æ¨¡å¼${reset}\n"
printf "${green}[+] nethunter kex stop    # åœæ­¢ GUI æ¨¡å¼${reset}\n"
printf "${green}[+] nethunter -r          # ä»¥ root èº«ä»½è¿è¡Œ${reset}\n"
printf "${green}[+] nh                    # å¿«æ·å‘½ä»¤${reset}\n\n"
printf "${yellow}[*] æ³¨æ„: é¦–æ¬¡å¯åŠ¨GUIéœ€è¦è¾ƒé•¿æ—¶é—´åˆå§‹åŒ–${reset}\n"
printf "${yellow}[*] æŠ€æœ¯æ”¯æŒ: QQç¾¤ 1040302092${reset}\n\n"
